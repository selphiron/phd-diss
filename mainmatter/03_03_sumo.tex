\chapter{Deriving a Realistic Cyclist Model from Cycling Trip Data}
\label{cha:sumo}
In this chapter, we describe how we derived a realistic cyclist model for SUMO based on the SimRa dataset.
The main idea is to deduce the lateral movement specifications, i.e. acceleration, deceleration and maximum velocity, as well as the left-turn behavior of cyclists at intersections by analyzing the SimRa dataset and adapting it to SUMO.

In SUMO, vehicles and their dynamics are simulated individually~\cite{lopez2018microscopic}.
Unfortunately, the cyclist model is not particularly realistic -- cyclists can either be modeled to behave as slow cars or as fast pedestrians.
Several studies have already improved the bicycle model of SUMO.
For instance, Kaths et al.~\cite{kaths2016integration} investigated the intersection behavior of cyclists using camera traces and transferred findings into SUMO.
Also, Grigoropoulos et al.~\cite{grigoropoulos2019modelling} improved the modeling of cycling infrastructure at intersections while Heinovski et al.~\cite{heinovski2019modeling} created a virtual cycling environment to import real cyclist behavior directly into SUMO.
Nevertheless, the current cyclist behavior in SUMO is still rather unrealistic; so far, researchers have devoted much more effort to car models, e.g., \cite{chandler1958traffic,gazis1961nonlinear,gipps1981behavioural, leutzbach1986development,bando1995dynamical,krauss1998microscopic,treiber2000congested,salles2020extending}.
One reason for this is that, until recently, not enough data on real-world cyclist behavior has been available.
Today, crowdsourced data collection approaches such as SimRa have made thousands of cycle tracks available as open data.

In this chapter, we analyze the SimRa dataset regarding the acceleration, deceleration, and velocity of cyclists as well as their left-turn behavior in four-way intersections.
We then use our findings to improve the cyclist model in SUMO.
Additionally, we add three more detailed cyclist models for slow, medium, and fast cyclists.
This chapter combines material published in \cite{karakaya2022realistic,karakaya2023achieving} and contains the following contributions:
\begin{itemize}
    \item We show that SUMO's default cyclist simulation is not realistic,
    \item we improve the cyclist simulation of SUMO by deriving new parameters for that vehicle type in SUMO,
    \item we add three new cyclist simulation models -- slow, medium, and fast -- to SUMO by splitting the SimRa dataset into slow, medium and fast trips.
    \item we develop an intersection model that captures cyclists' left-turn behavior at intersections in a more realistic way, and
    \item we compare our improvements to SUMO's default cyclist simulation, using the SimRa dataset as a ground truth.
\end{itemize}

This chapter is organized in the following manner:
\Cref{sec:sumo_background} has background information on SUMO.
\Cref{sec:cycling_behavior_in_simra_and_sumo} contains an analysis and comparison of cyclists' lateral movement and behavior at intersections in real life (SimRa dataset) and SUMO.
\Cref{sec:improving_sumos_bicycle_simulation} gives a description of how we implemented the insights gained from the analysis from the previous section.
\Cref{sec:evaluation_sumo} evaluates and \Cref{sec:discussion_sumo} discusses our approach.
\Cref{sec:related_work_sumo} gives an overview of alternative approaches and \Cref{sec:summary_sumo} concludes this chapter.

\section{SUMO -- Simulation of Urban Mobility}
\label{sec:sumo_background}
% sumo in general
SUMO is an open source traffic simulation tool that offers macroscopic as well as microscopic simulation of vehicle mobility~\cite{lopez2018microscopic}.
SUMO includes models for different types of ``vehicles'', including, among others, cars, bicycles, and even pedestrians.
Due to its large feature set, it has become the de-facto standard for traffic simulation and is used even beyond the transport community, e.g., \cite{beilharz2021towards}.

% network
Traffic scenarios are, among other things, defined by road networks and vehicle traffic.
The road network includes roads and their (sub-)lanes as well as exclusive lanes for cyclists and pedestrians, or road-side infrastructure such as traffic lights.
Furthermore, connections between these lanes and traffic lights can be configured.

% vtypes
When modeling vehicle traffic, users specify demand for a specific road segment per vehicle type and can adjust vehicle-specific parameters of SUMO's simulation model to control their respective behavior.
In general, vehicle parameters are usually specified in the vehicle type declaration (\textit{vType}), applying the changes to all instances of the respective \textit{vType}, e.g., to all cars.
An alternative, however, is to obtain multiple \textit{vType} realizations which typically differ in at least one parameter by using so-called \textit{vTypeDistributions}.
This way, when spawning a new vehicle, SUMO randomly picks a specific \textit{vType} from the \textit{vTypeDistribution} and instantiates the vehicle's parameters accordingly, e.g., cars can thus have individual maximum velocities.

% vehicle behavior
In SUMO, vehicle behavior is, among other things, defined by
\textit{Car Following (CF) models} for the longitudinal kinematic behavior,
\textit{Lane Change (LC) models} for the lateral kinematic behaviour,
and \textit{junction models} for the behavior at junctions and intersections.

% bicycles
Despite including several of these models for cars and trucks, SUMO does not provide a dedicated movement model for cyclists.
Instead, cyclists are simulated by modeling them either as slow cars or fast pedestrians.
Both of these approaches use movement models of the corresponding vehicle type and adapt their respective shape and kinematic characteristics (e.g., velocity and acceleration profiles) to match cyclists.
While this is obviously a rough approximation, it is unlikely to reflect the behavior of real-world cyclists~\cite{grigoropoulos2019modelling}.


\section{Cycling Behavior in SimRa and SUMO}
\label{sec:cycling_behavior_in_simra_and_sumo}
In this section, we analyze real-world cyclists' behavior extracted from the SimRa dataset\footnote{All numbers in this chapter regarding the SimRa dataset are as of January 2023} and compare it to the behavior of SUMO's default cyclist model.
SimRa's dataset stems from crowdsourced smartphone data generation and thus suffers from poor sensor quality~\cite{chowdhury2014estimating, usami2018bicycle} as well as heterogeneous hardware and users~\cite{basiri2018impact}.
This leads to a lot of unclean data, which we first need to filter out (\Cref{subsec:preprocessing_sumo}).
Since we want to create one general model for all cyclists and complement it with three dedicated models for slow, medium, and fast cyclists, we need to derive three distinct types from the SimRa dataset, which we do in \Cref{subsec:categorizing_by_velocity_preprocessing}.
We then analyze acceleration, deceleration and velocity behavior for each of the four models in \Cref{subsec:acceleration_preprocessing,subsec:deceleration_preprocessing,subsec:velocity_preprocessing} before discussing left-turn behavior at four-way intersections of the different models in \Cref{subsec:left-turn_behavior_at_intersections_preprocessing}.
We omit a detailed discussion of the right-turn behavior at intersections, since SUMO's default model does not deviate much from the behavior observed from SimRa's dataset.
When referring to SUMO's cyclist model, we refer to the ``slow car'' model of SUMO as the ``fast pedestrian'' model occasionally leads to poor results and was therefore not considered further.

\begin{table}
\centering
\caption{Most important attributes of entities of the SimRa dataset}%
\label{tab:dataset}
\begin{tabular}{ccc}
\toprule
& Total & Used \\
\midrule
\midrule
Trips & \num{60470} & \num{55175} \\
Accelerations & \num{12382675} & \num{2330292} \\
Decelerations & \num{12985955} & \num{2623904} \\
\bottomrule&
\end{tabular}
\end{table}

Aside from the public SimRa datasets~\cite{dataset_simra_set1,dataset_simra_set2, dataset_simra_set3} and more recent trips available on GitHub,\footnote{\url{https://github.com/simra-project/dataset}} we also used non-public trips which have, for privacy reasons, not been published yet.
\Cref{tab:dataset} summarizes the most important attributes of the dataset that we used.

We used trips from almost \num{100} SimRa regions when calculating the distributions for the maximum acceleration, maximum deceleration, and maximum velocity of cyclists.

\subsection{Preprocessing}
\label{subsec:preprocessing_sumo}
\begin{figure}[ht]
  \centering
    \includegraphics[width=0.7\columnwidth]{fig/analysis_avg_velo_all_trips.pdf}
    \caption{%
        Histogram of the empirical average velocity capabilities of cyclists found in the SimRa dataset. The average velocity of all cycling trips after the preprocessing is \SI{4.38}{\metre\per\second} with a standard deviation of \num{0.89} and a median of \SI{4.42}{\metre\per\second}.
    }%
    \label{fig:analysis_avg_vel_all}
\end{figure}

To achieve the best possible data quality, we tested various pre-processing techniques and filters.
We also conducted an experiment in which sample trajectories were recorded in parallel on several SimRa client devices and compared to a ground truth trajectory recorded by a stand-alone \ac{gps} receiver.
In the end, we used a Gaussian Kernel filter for improving location data and a Low Pass filter for the velocity data.
Additionally, the SimRa dataset contains information about the location accuracy, which we use to filter out trips where the \ac{gps} accuracy suffered greatly.
After filtering semantically and syntactically defective files, we used data from \num{55175} trips, which is around \num{91}\% of the initial dataset as input for our analysis scripts.\footnote{\url{https://github.com/simra-project/SimRaXSUMO}}
\subsection{Categorizing Cyclists by Velocity}
\label{subsec:categorizing_by_velocity_preprocessing}
To get different types of cyclists, we decided to analyze the average velocity of each trip after filtering out the stops.
\Cref{fig:analysis_avg_vel_all} shows the distribution of the average velocities of each trip in the SimRa dataset.
This does not present an obvious way to split the dataset into three types, which is why we have split the dataset from a SUMO users' perspective.
We, hence, decided to split the dataset so, that the \num{25}\% slowest and the \num{25}\% fastest trips represent the slow and the fast cyclists respectively, which leaves the middle \num{50}\% to the medium-paced cyclists.
This results in the following cyclist type velocities:
\textit{Slow cyclists} have an average cycling velocity of up to \SI{13.5}{\km\per\hour}.
\textit{Medium cyclists} have an average cycling velocity between \SI{13.5}{\km\per\hour} and \SI{17.9}{\km\per\hour}.
\textit{Fast cyclists} have an average cycling velocity above \SI{17.9}{\km\per\hour}.
We have chosen against an equal split and in favor of a \num{25}\%-\num{50}\%-\num{25}\% split, because we think that the majority of the cyclists should be in the same cyclist type, namely, the medium cyclist type.

\subsection{Acceleration}
\label{subsec:acceleration_preprocessing}
%  ____  _   _ __  __  ___                  ____  _           ____
% / ___|| | | |  \/  |/ _ \  __   _____    / ___|(_)_ __ ___ |  _ \ __ _
% \___ \| | | | |\/| | | | | \ \ / / __|   \___ \| | '_ ` _ \| |_) / _` |
%  ___) | |_| | |  | | |_| |  \ V /\__ \_   ___) | | | | | | |  _ < (_| |
% |____/ \___/|_|  |_|\___/    \_/ |___(_) |____/|_|_| |_| |_|_| \_\__,_|
\begin{figure}
    %\vspace{-3em}
    \centering
    \subfloat[All cyclists]{\includegraphics[width=0.4\columnwidth]{fig/analysis_max_acceleration_dist_fit_all.pdf}\label{fig:analysis_max_acceleration_dist_fit_all}}
    \hfill
    \subfloat[\num{3} cyclist groups: slow ($s$), medium ($m$), and fast ($f$)]{\includegraphics[width=0.4\columnwidth]{fig/analysis_max_acceleration_dist_fit_groups.pdf}\label{fig:analysis_max_acceleration_dist_fit_groups}}
    \caption{%
        Histogram of maximum acceleration capabilities found in the empirical SimRa dataset and their respective distribution functions.
        The red scalar represents the default value in SUMO.
    }%
    \label{fig:analysis_max_acceleration_dist_fit}
\end{figure}

For analyzing cyclist acceleration, we extracted acceleration maneuvers from the dataset.
For this, we slightly adapted the approach of \cite{ma2016modeling}.
First, we split the velocity profile at its local extrema to get segments where the cyclist accelerates/decelerates.
Then, we consider only segments with a distance from \SI{20}{\metre} to \SI{350}{\metre} and a duration between \SI{5}{\second} to \SI{40}{\second}.
We also make sure to filter out segments where the variance in velocity is too low, i.e., such that $ \frac{|v_{s} - v_{e}|}{max(v_{s},v_{e})} > 0.5 $, where $v_{s}$ and $v_{e}$ are the velocities at the start and end of a segment.
With that approach we found \num{228347} acceleration maneuvers in the cleaned dataset.
Distribution fitting processes, which were done with SciPy\footnote{\url{https://scipy.org/}}, showed that the Burr (Type XII) distribution~\cite{burr1942cumulative} $Burr12(x; c,d) = c*d*\frac{x^{c-1}}{(1+x^c)^{d+1}}$ for $x = a_{max} \geq 0$ and $c,d > 0$  fits the data best for the general cyclist model (see also \Cref{fig:analysis_max_acceleration_dist_fit_all}).
For the models of the slow and fast cyclist models, the Burr (Type III) distribution~\cite{burr1942cumulative}

$Burr3(x; c,d) = c*d*\frac{x^{-c-1}}{(1+x^c)^{d+1}}$ for $x = a_{max} \geq 0$ and $c,d > 0$ fits the data best, while the Mielke Beta-Kappa distribution~\cite{mielke1973another}

$M\beta\kappa(x; c,d) = \frac{k*x^{k-1}}{(1+x^s)^{1+k/s}}$ for $x = a_{max} > 0$ and $k,s > 0$ is the best fit for the medium cyclist model's acceleration distribution (see also \Cref{fig:analysis_max_acceleration_dist_fit_groups}).

Comparing the acceleration capability of actual cyclists (the SimRa dataset) with the default SUMO cyclist model, differences become apparent.
By default, SUMO specifies $a_{max}^{SUMO}$ with \SI{1.2}{\metre\per\square\second}.
This deviates significantly from the findings in the SimRa dataset where only \num{15}\% of the acceleration maneuvers are executed with a maximum acceleration of \SI{1.2}{\metre\per\square\second} or higher.
Furthermore, the empirical distributions are rather wide, indicating a broad variance across different cyclist types and cycling situations, which is in stark contrast to SUMO's strategy of choosing a fixed maximum value.

\subsection{Deceleration}
\label{subsec:deceleration_preprocessing}

%  ____  _   _ __  __  ___                  ____  _           ____
% / ___|| | | |  \/  |/ _ \  __   _____    / ___|(_)_ __ ___ |  _ \ __ _
% \___ \| | | | |\/| | | | | \ \ / / __|   \___ \| | '_ ` _ \| |_) / _` |
%  ___) | |_| | |  | | |_| |  \ V /\__ \_   ___) | | | | | | |  _ < (_| |
% |____/ \___/|_|  |_|\___/    \_/ |___(_) |____/|_|_| |_| |_|_| \_\__,_|
\begin{figure}
    \centering
    \subfloat[All cyclists]{\includegraphics[width=0.4\columnwidth]{fig/analysis_max_deceleration_dist_fit_all.pdf}\label{fig:analysis_max_deceleration_dist_fit_all}}
    \hfill
    \subfloat[\num{3} cyclist groups: slow ($s$), medium ($m$), and fast ($f$)]{\includegraphics[width=0.4\columnwidth]{fig/analysis_max_deceleration_dist_fit_groups.pdf}\label{fig:analysis_max_deceleration_dist_fit_groups}}
    \caption{%
        Histogram of maximum deceleration capabilities found in the empirical SimRa dataset and their respective distribution functions.
        The red scalar represents the default value in SUMO.
    }%
    \label{fig:analysis_max_deceleration_dist_fit}
\end{figure}

For analyzing cyclist deceleration, we extracted deceleration maneuvers from the dataset (see \Cref{subsec:acceleration_preprocessing}).
Distribution fitting processes showed here that the Johnson's $S_{U}$-distribution~\cite{johnson1949systems} $JSU(x; a,b) = \frac{b}{\sqrt{x^2+1}}\phi(a+b*log(x+\sqrt{x^2+1}))$ for $x=d_{max}$ and $b>0$ with $\phi$ being the probability density function of the normal distribution, fits the data best for the general cyclist model (see also \Cref{fig:analysis_max_deceleration_dist_fit_all}).
$JSU(d_{max}; a,b)$ was also the best fit for the slow and medium cylist models, whereas the fast cyclists' data was the best fit for the Student's $t$-distribution~\cite{student1908probable} $t(x; \nu)=\frac{\Gamma((\nu+1)/2)}{\sqrt{\pi*\nu}*\Gamma(\nu/2)}*(1+x^2/\nu)^{-(\nu+1)/2}$ for $x=d_{max}$ (see also \Cref{fig:analysis_max_deceleration_dist_fit_groups}).

Comparing the deceleration capability of actual cyclists (the SimRa dataset) with the default SUMO cyclist model, differences become apparent.
By default, SUMO specifies $d_{max}^{SUMO}$ with \SI{-3}{\metre\per\square\second}.
This deviates extremely from the findings in the SimRa dataset where none of the deceleration maneuvers are executed with a maximum acceleration of \SI{-3}{\metre\per\square\second} or lower.
Furthermore, the empirical distributions are rather wide, indicating a broad variance across different cyclist types and cycling situations, which is in stark contrast to SUMO's strategy of choosing a fixed maximum value.

\subsection{Velocity}
\label{subsec:velocity_preprocessing}
%  ____  _   _ __  __  ___                  ____  _           ____
% / ___|| | | |  \/  |/ _ \  __   _____    / ___|(_)_ __ ___ |  _ \ __ _
% \___ \| | | | |\/| | | | | \ \ / / __|   \___ \| | '_ ` _ \| |_) / _` |
%  ___) | |_| | |  | | |_| |  \ V /\__ \_   ___) | | | | | | |  _ < (_| |
% |____/ \___/|_|  |_|\___/    \_/ |___(_) |____/|_|_| |_| |_|_| \_\__,_|

\begin{figure}
    %\vspace{-3em}
    \centering
    \subfloat[All cyclists]{\includegraphics[width=0.4\columnwidth]{fig/analysis_max_velo_dist_fit_all.pdf}\label{fig:analysis_max_velo_dist_fit_all}}
    \hfill
    \subfloat[\num{3} cyclist groups: slow ($s$), medium ($m$), and fast ($f$)]{\includegraphics[width=0.4\columnwidth]{fig/analysis_max_velo_dist_fit_groups.pdf}\label{fig:analysis_max_velo_dist_fit_groups}}
    \caption{%
        Histogram of maximum velocity capabilities found in the empirical SimRa dataset and their respective distribution functions.
        The red scalar represents the default value in SUMO.
    }%
    \label{fig:analysis_max_velo_dist_fit}
    \vspace{-.5em}
\end{figure}

To gain insights into cyclists' behavior regarding their velocities, we calculate the maximum velocity for each trip file in the cleaned SimRa dataset.
Using distribution fitting, we found that the symmetric generalized normal distribution~\cite{nadarajah2005generalized} $SGND(x;\beta) = \frac{\beta}{2*\Gamma(1/\beta)}*exp(-|x|^\beta)$ for $x=v_{max}$ fits the empirical data of all cyclists best (see also \Cref{fig:analysis_max_velo_dist_fit_all}) and is therefore a valid fit for the specification of the empirical distribution of $v_{max}^{SimRa}$ for the general cyclist model.
For the model of the slow cyclists, the Johnson's $S_{U}$-distribution~\cite{johnson1949systems} $JSU(v_{max}; \Phi\mbox{*})$ fits the data best, while the best fit for the medium cyclists' model is the Exponentially Modified Gaussian distribution~\cite{grushka1972characterization} $EMG(x; K) = \frac{1}{2*K}*exp(\frac{1}{2*K^2}-x/K)erfc(-\frac{x-1/K}{\sqrt{2}})$ for $x = v_{max}$ and $K>0$.
Finally, the non-central $t$-distribution~\cite{hogben1961moments} $NCT\newline(v_{max}; \Phi\mbox{*})$ emerged as the best fit for the fast cyclists' data.

On the other hand, SUMO sets $v_{max}^{SUMO}$ at \SI{5.56}{\metre\per\s} by default.
This deviates significantly from the findings in the SimRa dataset where \num{77}\% of the trips have a higher maximum velocity.
Bringing this together with the acceleration findings, real-world cyclists often (but not always) cycle much faster than SUMO cyclists and vary much more in their acceleration behavior.

\subsection{Left-turn Behavior at Intersections}
\label{subsec:left-turn_behavior_at_intersections_preprocessing}
%  ____  _   _ __  __  ___                  ____  _           ____
% / ___|| | | |  \/  |/ _ \  __   _____    / ___|(_)_ __ ___ |  _ \ __ _
% \___ \| | | | |\/| | | | | \ \ / / __|   \___ \| | '_ ` _ \| |_) / _` |
%  ___) | |_| | |  | | |_| |  \ V /\__ \_   ___) | | | | | | |  _ < (_| |
% |____/ \___/|_|  |_|\___/    \_/ |___(_) |____/|_|_| |_| |_|_| \_\__,_|
\begin{figure}
    \centering
    \includegraphics[width=0.5\columnwidth]{fig/analysis_im_loc_default.pdf}
    \caption{%
        Qualitative comparison between the SUMO default intersection model and real world data given by SimRa for the intersection between Alexanderstraße and Karl-Marx-Allee in Berlin.
        SimRa shows two distinct left-turn paths (i.e., a direct and an indirect one) whereas SUMO default only models the direct path.
    }%
    \label{fig:analysis_im_traj_default}
\end{figure}

According to the SimRa dataset, cyclists either behave like cars (using the normal road) or pedestrians (using the pedestrian crossing) to take left-turns at intersections.
We call the former a \textit{direct} left turn and the latter an \textit{indirect} left turn.

SUMO's default model only provides cyclists with an unrealistic "bicycle-lane-to-bicycle-lane-left-turn" (see also \Cref{fig:analysis_im_traj_default}), where the cyclist enters the intersection from a bicycle lane, crossing all car lanes and directly entering the bicycle lane again.

Taking a closer look at real world intersections in the SimRa dataset revealed that there are mainly two intersection types.
In the first intersection type, the \textit{indirect} path is chosen with a probability of \num{61}\% when all cyclists are considered, while medium cyclists and fast cyclists prefer the indirect path with a probability of \num{87}\% and \num{50}\% respectively.
However, on the second intersection type, almost all cyclists choose the \textit{indirect} path.
Slow cyclists almost never tend to do direct left-turns, since they presumably avoid car traffic the most.
Randomly investigating intersections of both types revealed that the first intersection type has no specific characteristics while the second intersection type actively encourages cyclists to indirect turns through the design of the intersection, e.g., by having a traffic island in the center.
Since such information cannot be identified in \ac{osm} data reliably and in an abstract way, we will consider only the first intersection type in the following.

SUMO and real world data differ decisively in all metrics considered, namely acceleration, velocity, and left-turn behavior at intersections.
However, these three metrics are crucial for realistically simulating bicycle traffic.
In the following, we try to adapt SUMO to simulate a more realistic cyclist behavior by introducing three different cyclist types.


\section{Improving SUMO's Cyclist Simulation}
\label{sec:improving_sumos_bicycle_simulation}
To improve the simulation, we propose three changes to SUMO's cyclist model:
First, the longitudinal kinematic parameters of SUMO's default cyclist model are \mbox{(re-)}parameterized based on the findings from the SimRa dataset.
Second, a novel simulation model is derived from SimRa trajectories to exclusively simulate realistic left-turn cyclist behavior at intersections based on the findings in \Cref{sec:cycling_behavior_in_simra_and_sumo}.
The latter model is referred to as the intersection model in the following.
Third, four different cyclist models, with different longitudinal kinematic and left-turn behaviors depending on the findings from \Cref{sec:cycling_behavior_in_simra_and_sumo} are derived.
One model is for all cyclists combined and the three other models are for modeling slow, medium and fast cyclists respectively.


\subsection{Longitudinal Kinematic Behavior}
\label{subsec:longitudinal_kinematic_behavior}
In \Cref{sec:cycling_behavior_in_simra_and_sumo}, we derived maximum acceleration, maximum deceleration and maximum velocity characteristics from the SimRa dataset.
We now use them to improve the longitudinal kinematic behavior of the default SUMO cyclist model.
Contrary to the default parameterization, we use theoretical distribution functions instead of scalar values for the exposed kinematic parameters.
This enables the model to produce more realistic cyclist simulation results since the heterogeneity of real world cycling styles is reflected.

We derive the theoretical distributions by aggregating the respective features from \Cref{subsec:acceleration_preprocessing,subsec:deceleration_preprocessing,subsec:velocity_preprocessing}.
For this, we rely on the \textit{law of large numbers} which states that the average of the results obtained from a large number of trials of the same experiment eventually converges to its true expected value~\cite{etemadi1981elementary}.
In the context of this work, this means that individual trips do not matter but that the aggregates of multiple trips will converge towards their actual expected value given a sufficiently large number of trips.

For the implementation, we used \textit{vTypeDistributions} following the results of our previous analysis and sample both distribution independently.

It should be noted that through the parameterizations with theoretical probability density functions SUMO's \textit{speedDev} parameter becomes obsolete as variance between the kinematic preferences among cyclists are already represented by the distribution function.

Furthermore, alternatives for the acceleration parameters have been added to SUMO.
This enables a user to pick a normal distribution and choose the parameters for it, which would yield more realistic scenario data contrary to using a simple scalar value for the acceleration.

\subsection{Left-turn Behavior at Intersections}
\label{subsec:left-turn_behavior_at_intersections}
To improve the degree of realism in cyclists' left-turn behavior at signaled intersections, we use an adapted version of the external intersection model (a Python script that steers cyclists via SUMO's \textit{Traffic Control Interface}) as proposed by \textcite{kaths2016integration} which is based on previously recorded real-world trajectories for cyclists across a single predefined intersection.
Our approach algorithmically synthesizes the cyclists' trajectories (i.e., their respective routes across the intersection) for any regular four-way intersection and can therefore be seen as a step towards a more universal solution.

The left-turn maneuver distribution, as we call it, specifies the probability of the cyclists choosing either the \textit{direct} or the \textit{indirect} path to cross the intersection.
For this, we use the distributions derived in \Cref{subsec:left-turn_behavior_at_intersections_preprocessing} as the default for our intersection model for each different cyclist group.
Users, however, can adjust the distributions if desired or needed for their specific purposes (see also the exception cases in \Cref{subsec:left-turn_behavior_at_intersections_preprocessing}).

In order to simplify the process and to improve performance, we decided to integrate this feature into the SUMO core.
The implementation provides a new parameter that lets the user adjust the indirect left turn probability of a cycling trip.
To detail the workflow, the cyclist makes a decision before each intersection, where there is at least one direct and indirect left-turn available to choose from.
This delegates decisions inside SUMO just by using the bicycle vehicle type parameter.

\subsection{Different Cyclist Models}
\label{subsec:different_cyclist_models}

Our approach defines distibutions of models derived from the same default implementation of SUMO.
The models vary only in the parameter values used.
The parameters considered are maximum acceleration (\textit{accel}), maximum deceleration (\textit{decel}) and maximum velocity (\textit{maxSpeed}), splitted into \num{3} groups, as it can be seen in \Cref{subsec:acceleration_preprocessing,subsec:deceleration_preprocessing,subsec:velocity_preprocessing}.
In order to leverage distribution parameters for a cyclist model, we used the \textit{vTypeDistribution} from SUMO to define a distribution of cyclists having all the parameters mentioned.

With this data ready, the only remaining step is to augment these groups with a left-turn behavior probability per group.
In order to make a decision whether to do a direct or an indirect left-turn, we approached the problem by using a script that controls the cyclists, as described in \Cref{subsec:left-turn_behavior_at_intersections}.

Thus, this group-based model enables the user to simulate bicycle traffic in SUMO more realistically.

\section{Evaluation}
\label{sec:evaluation_sumo}
In this section, we evaluate the new cyclist models from \Cref{sec:improving_sumos_bicycle_simulation} by comparing them to each other and to SUMO's default simulation model and the real-world data taken from the SimRa data set.
We start by introducing the simulation setup (\Cref{subsec:simulation_setup}) which we used to create and run the scenarios with.
We then continue analyzing acceleration (\Cref{subsec:acceleration_evaluation}), deceleration (\Cref{subsec:deceleration_evaluation}), velocity (\Cref{subsec:velocity_evaluation}), and left-turn behavior at intersections (\Cref{subsec:left-turn_behavior_at_intersections_evaluation}) before evaluating the combination of all model extensions (\Cref{subsec:combinin_intersection_model_and_kinematic_extension}).
Please note: While it may appear obvious that using the SimRa data set for both parameterization and evaluation should lead to perfect results, this is not the case as our extensions are subject to the design restrictions imposed by SUMO.

\subsection{Simulation Setup}
\label{subsec:simulation_setup}
% scenarios
As SUMO users can import real-world scenarios from \ac{osm} data, simulation results can be compared to real-world data and thus be evaluated.
For our evaluation, we chose specific traffic scenarios from multiple SimRa regions that are representative and likely to showcase both strengths and weaknesses of our extensions.
Likewise, we do not show every cyclist type's results in detail to avoid too many figures and tables.
For evaluating the longitudinal behavior (acceleration, deceleration and velocity), we chose urban traffic scenarios with long straight sections.
As example locations, we use \textit{Oranienstraße} in Berlin, \textit{Dachauer Straße} in Munich and \textit{Frauentorgraben} in Nuremberg.
For evaluating left-turn behavior, we chose compact scenarios around signaled intersections with multiple lanes on each axis.
For this, we study three intersections in Berlin, namely at \textit{Mehringdamm} (see also \Cref{fig:mehringdamm_sumo}), \textit{Warschauer Straße}, and \textit{Alexanderstraße}.

\begin{table}%
\centering
\caption{Most important attributes of our simulation scenarios.}%
\label{tab:scenarios}
%\resizebox{\columnwidth}{!}{
\begin{tabular}{ccccc}%
\toprule%
                & Cars  & Bicycles & Distance & Lanes\\%
\midrule%
\midrule%
Oranienstr.     & \num{3158} & \num{300}      & \num{1528}    & --\\%
Dzchauer Str.   & \num{3427} & \num{300}      & \num{1204}    & --\\%
Frauentorgraben & \num{1625} & \num{300}      & \num{1023}    & --\\%
Mehringdamm     & \num{180}   & \num{2700}    & --       & \num{29}\\%
Warschauer Str. & \num{180}   & \num{2700}    & --       & \num{26}\\%
Alexanderstr.   & \num{180}   & \num{2700}    & --       & \num{25}\\%
\bottomrule&%
\end{tabular}%
%}
\end{table}

We made our scenarios as realistic as possible by choosing main roads and intersections with a lot of traffic and also added a significant number of cars, as \Cref{tab:scenarios} shows.
\begin{figure}
    \centering
    \includegraphics[width=0.5\columnwidth]{fig/mehringdamm_screenshot.png}
    \caption{%
        Excerpt from the \textit{Mehringdamm} scenario in SUMO.
        The scenario was created using \ac{osm} data only.
    }%
    \label{fig:mehringdamm_sumo}
\end{figure}

% simulation and environment and parameterization
For our evaluation, we use SUMO version 1.14.0 and a step size of \SI{1}{\s} in simulations.
The SUMO default results are obtained with SUMO's \textit{vType} \texttt{Bicycle} for cyclists, i.e., the maximum acceleration, maximum deceleration and maximum velocity are scalars and set to \SI{1.2}{\m\per\s\squared}, \SI{-3}{\m\per\s\squared} and \SI{5.56}{\m\per\s} respectively.

\subsection{Acceleration}
\label{subsec:acceleration_evaluation}
\begin{figure}
    \vspace{-1.5em}
    \centering
    \subfloat[All cyclists]{\includegraphics[width=0.4\columnwidth]{fig/eval_acc_all.pdf}\label{fig:eval_acc_all}}
    \hfill
    \subfloat[Only cyclist group slow ($s$)]{\includegraphics[width=0.4\columnwidth]{fig/eval_acc_slow.pdf}\label{fig:eval_acc_slow}}
    \caption{%
        Histogram of SUMO's, SimRa's, and our approach's observed maximum accelerations inside the example \textit{Frauentorgraben} scenario.
        While the maximum accelerations are heterogeneously distributed in the real-world data and our approach, the default values are clustered.
        Here, the observed accelerations deviate from the configured default value (\SI{1.2}{\metre\per\square\second}) due to traffic effects inside the simulation.
    }%
    \label{fig:eval_acc}
\end{figure}

\Cref{fig:eval_acc_all} shows the empirical distributions of the maximum acceleration among all cyclist types inside the \textit{Frauntorgraben} scenario simulation and the corresponding real world data.
It is evident that real-world acceleration maneuvers show heterogeneous maximum rates of acceleration.
The same is true for the three cyclist groups of our new approach as \Cref{fig:eval_acc_slow} shows.
Note that the other two cyclist groups, namely slow and medium, allow the same conclusion and, that we have randomly chosen the slow cyclist group to visualize in \Cref{fig:eval_acc_slow} to make the figure more readable.
Apparently, the default parameterization is not suitable to describe this acceleration behavior among cyclists, as it provides homogeneous maximum acceleration rates within the simulation.
Our new parameterization -- for all cyclists and for each of the cyclist types -- is significantly closer to the real-world behavior in the SimRa data set with its highly heterogeneous behavior across cyclists.
\begin{table}
\centering
\caption{Results Overview Maximum Acceleration Comparing SUMO Default, Our Approach (All), Our Approach (Slow), SimRa (All) and SimRa (Slow)}%
\label{tab:results_overview_acc}
\begin{tabular}{cccc}
\toprule
& Mean & Std. Deviation & Median\\
\midrule
\midrule
SUMO default & \num{1.178} & \num{0.019} & \num{1.18} \\
\midrule
Our approach (\textit{all}) & \num{0.921} & \num{0.218} & \num{0.95} \\
SimRa (\textit{all}) & \num{0.761} & \num{0.217} & \num{0.71} \\
\midrule
Our approach (\textit{s}) & \num{0.727} & \num{0.168} & \num{0.74} \\
SimRa (\textit{s}) & \num{0.656} & \num{0.109} & \num{0.65} \\
\bottomrule&
\end{tabular}
\end{table}
This can also be seen, when comparing the mean, standard deviation and median values of SUMO default, all and slow (\textit{s}) cyclists (both in the SimRa dataset and our approach) depicted in \Cref{tab:results_overview_acc}.
It also shows, that the division of the cyclist into subgroups further increases the realism, since the difference between the mean and median values of our approach (\textit{all}) and Simra (\textit{all}) shrinks, compared to our approach (\textit{s}) and Simra (\textit{s}).
The standard deviation suffers though, which is probably due to less trips being regarded, because of the splitting into three subgroups.
Please note also here, that we omitted the medium and fast cycling groups to stay consistent with \Cref{fig:eval_acc_slow} and avoid clutter.
That our new parameterizations are not a perfect fit indicates that there are probably additional influence factors, e.g., the traffic density or the weather situation, not covered in our kinematic models which aggregate data from all SimRa trips.

\subsection{Deceleration}
\label{subsec:deceleration_evaluation}
\begin{figure}
    %\vspace{-3em}
    \centering
    \subfloat[All cyclists]{\includegraphics[width=0.4\columnwidth]{fig/eval_dec_all.pdf}\label{fig:eval_dec_all}}
    \hfill
    \subfloat[Only cyclist group medium ($m$)]{\includegraphics[width=0.4\columnwidth]{fig/eval_dec_medium.pdf}\label{fig:eval_dec_medium}}
    \caption{%
        Histogram of SUMO's, SimRa's, and our approach's observed maximum decelerations inside the example \textit{Dachauer Straße} scenario.
        While the maximum decelerations are heterogeneously distributed in the real-world data and our approach, the default values are clustered.
        Here, the observed decelerations deviate from the configured default value (3m/s\textsuperscript{2}) due to traffic effects inside the simulation.
    }%
    \label{fig:eval_dec}
\end{figure}

\Cref{fig:eval_dec_all} shows the empirical distributions of the maximum deceleration among all cyclist types inside the \textit{Dachauer} \textit{Straße} scenario simulation and the corresponding real world data.
Here, we only show the medium cyclist group as an example to avoid clutter, the other two cycling groups (slow and fast) show very similar results.
It is evident that real-world deceleration maneuvers show heterogeneous maximum rates of deceleration.
The same is true for the medium cyclists as \Cref{fig:eval_dec_medium} shows.
Here, too, the default parameterization is not suitable to describe this deceleration behavior among cyclists, as it provides homogeneous maximum deceleration rates within the simulation.
Our new parameterization -- for all cyclists and for each of the cyclist types -- is significantly closer to the real-world behavior in the SimRa data set with its highly heterogeneous behavior across cyclists.
\begin{table}
\centering
\caption{Results Overview Maximum Deceleration Comparing SUMO Default, Our Approach (All), Our Approach (Medium), SimRa (All) and SimRa (Medium)}%
\label{tab:results_overview_dec}
\begin{tabular}{cccc}
\toprule
& Mean & Std. Deviation & Median\\
\midrule
\midrule
SUMO default & \num{2.664} & \num{0.507} & \num{2.77} \\
\midrule
Our approach (\textit{all}) & \num{1.071} & \num{0.336} & \num{1.09} \\
SimRa (\textit{all}) & \num{0.962} & \num{0.141} & \num{0.96} \\
\midrule
Our approach (\textit{m}) & \num{0.949} & \num{0.362} & \num{0.93} \\
SimRa (\textit{m}) & \num{0.973} & \num{0.100} & \num{0.98} \\
\bottomrule&
\end{tabular}
\end{table}
As for the maximum acceleration, \Cref{tab:results_overview_dec} shows, that our approach is not only more realistic than SUMO's default cyclist model (both with all and medium (\textit{m}) cyclists), but the introduction of the cyclist groups increases the realism.
The medium cyclist group was randomly chosen as a representative for the other groups, since the conclusion does not differ.
Influence factors, such as the traffic density or the weather situation, not covered in our kinematic models which aggregate data from all SimRa trips, result in a non-perfect fit for our new parameterizations.
Note, that we had to filter out deceleration values, that we deemed too high (above \SI{7}{\m\per\s\squared}), to avoid recording emergency deceleration, which is another parameter in SUMO's vehicle parameterization.

\subsection{Velocity}
\label{subsec:velocity_evaluation}
\begin{figure}
    \centering
    \subfloat[All cyclists]{\includegraphics[width=0.4\columnwidth]{fig/eval_velo_all.pdf}\label{fig:eval_velo_all}}
    \hfill
    \subfloat[Only cyclist group fast ($f$)]{\includegraphics[width=0.4\columnwidth]{fig/eval_velo_fast.pdf}\label{fig:eval_velo_fast}}
    \caption{%
        Histogram of SUMO's, SimRa's, and our approach's observed maximum velocities inside the example \textit{Oranienstraße} scenario.
        While the maximum velocities are heterogeneously distributed in the real-world data and our approach, the default values are clustered.
    }%
    \label{fig:eval_velo}
\end{figure}

\Cref{fig:eval_velo_all} shows the empirical distributions of all cyclists' maximum velocities in the \textit{Oranienstraße} scenario simulation and the real-world scenario.
As with maximum acceleration and deceleration rates, maximum velocities vary widely among real-world cyclists and we only depict one cyclist group (this time fast cyclists) as an example for other groups to increase the readability of the figure.
Once more, the default parameterization is not able to reflect this characteristic.
This is also the case for the different cyclist groups as \Cref{fig:eval_velo_fast} shows exemplary.
\begin{table}
\centering
\caption{Results Overview Maximum Velocity Comparing SUMO Default, Our Approach (All), Our Approach (Fast), SimRa (All) and SimRa (Fast)}%
\label{tab:results_overview_vel}
\begin{tabular}{cccc}
\toprule
& Mean & Std. Deviation & Median\\
\midrule
\midrule
SUMO default & \num{5.555} & \num{0.002} & \num{5.556} \\
\midrule
Our approach (\textit{all}) & \num{6.589} & \num{1.234} & \num{6.58} \\
SimRa (\textit{all}) & \num{7.072} & \num{0.904} & \num{7.10} \\
\midrule
Our approach (\textit{f}) & \num{8.272} & \num{0.902} & \num{8.20} \\
SimRa (\textit{f}) & \num{7.872} & \num{0.738} & \num{7.86} \\
\bottomrule&
\end{tabular}
\end{table}
According to \Cref{tab:results_overview_vel} the maximum velocity aspect of our simulation is the closest, when compared to maximum acceleration and maximum deceleration of all and fast (\textit{f}) cyclist groups in SimRa and our approach.
This is probably due to the fact, that we split the cyclist based on the average velocity.
Our new parameterization is thus significantly closer to the real-world behavior of cyclists.
As for acceleration and deceleration behaviors, the fact that our new parameterization is not a perfect fit to the real-world data indicates that there are likely to be additional influence factors not captured in our model.

\subsection{Left-turn Behavior at Intersections}
\label{subsec:left-turn_behavior_at_intersections_evaluation}

%  _   _ _______        __                ____  _           ____
% | \ | | ____\ \      / / __   _____    / ___|(_)_ __ ___ |  _ \ __ _
% |  \| |  _|  \ \ /\ / /  \ \ / / __|   \___ \| | '_ ` _ \| |_) / _` |
% | |\  | |___  \ V  V /    \ V /\__ \_   ___) | | | | | | |  _ < (_| |
% |_| \_|_____|  \_/\_/      \_/ |___(_) |____/|_|_| |_| |_|_| \_\__,_|
\begin{figure}
    \centering
    \subfloat[Only cyclist group slow ($s$)]{\includegraphics[width=.25\textwidth]{fig/eval_im_loc_im_slow.pdf}\label{fig:eval_im_traj_slow}}
    \hfill
    \subfloat[Only cyclist group medium ($m$)]{\includegraphics[width=.25\textwidth]{fig/eval_im_loc_im_medium.pdf}\label{fig:eval_im_traj_medium}}
    \hfill
    \subfloat[Only cyclist group fast ($f$)]{\includegraphics[width=.25\textwidth]{fig/eval_im_loc_im_fast.pdf}\label{fig:eval_im_traj_fast}}
    \caption{%
        Qualitative comparison between the results of our approach for the intersection model and real-world raw \ac{gps} data given by SimRa for the intersection between Alexanderstraße and Karl-Marx-Allee in Berlin.
        SimRa shows two distinct left-turn paths (i.e., a direct and an indirect one), which are also modeled by our models.
        Also the three different groups have different shares between direct and indirect left-turns.
    }%
    \label{fig:eval_im_traj_new}
\end{figure}

As shown in \Cref{fig:eval_im_traj_new}, which shows the intersection between Alexanderstraße and Karl-Marx-Allee in Berlin, the 2D trajectories produced by the new intersection models converge towards the trajectories of the SimRa data set.
While the trajectories produced by SUMO's default cyclist model, as can be seen in \Cref{fig:analysis_im_traj_default}, only offer direct "bike-lane-to-bike-lane" turns, the new model is significantly closer to real-world intersection behavior of cyclists.
This is true for all of our cyclist models.
Here, we see again the different left-turn behaviors of different cyclist types.
While slow cyclist only prefer the indirect left-turn, the medium and fast cyclists are more inclined to take the direct left-turn comparatively.

\subsection{Combining Intersection Model and Kinematic Extension}
\label{subsec:combinin_intersection_model_and_kinematic_extension}
To achieve a holistic comparison between SUMO's default cyclist model and our new models, we measure the durations of left-turn maneuvers at multiple intersections and compare the empirical distributions of these measurements.
To specifically monitor the impact of our changes, we do not include any trip time before or after the intersection in the measurements.
Note that we also omit the slow trips, since no or too few slow trips went through the intersections presented here.

Based on this, we identified the following four findings:
%% BEST MATCH
% __        ___    ____  ____   ____ _   _    _   _   _ _____ ____
% \ \      / / \  |  _ \/ ___| / ___| | | |  / \ | | | | ____|  _ \
%  \ \ /\ / / _ \ | |_) \___ \| |   | |_| | / _ \| | | |  _| | |_) |
%   \ V  V / ___ \|  _ < ___) | |___|  _  |/ ___ \ |_| | |___|  _ <
%    \_/\_/_/   \_\_| \_\____/ \____|_| |_/_/   \_\___/|_____|_| \_\
\begin{figure}
    \centering
    \includegraphics[width=0.7\columnwidth]{fig/im_warschauer_ecdf_every.pdf}
    \caption{%
        ECDFs of the measured durations for crossing the scenario \textit{Warschauer Straße}.
        It is apparent that our models for all, medium ($m$) and fast ($f$) cyclists outperform SUMO's default as the measured durations converge towards the real-world data.
        Only our fast cyclist model ($f$) is just marginally better than SUMO's default.
    }%
    \label{fig:im_warschauer}
\end{figure}
First, our new models outperform the default at most intersections, as its measured durations converge with real data, see for example \Cref{fig:im_warschauer}.
Especially when given the option to use the \textit{indirect} path, cyclists take longer to cross an intersection as they need to stop at an additional traffic light.
This is consistent with real-world data as we find it in the SimRa dataset at multiple intersections.

%% QUITE GOOD MATCH
%  __  __ _____ _   _ ____  ___ _   _  ____ ____    _    __  __ __  __
% |  \/  | ____| | | |  _ \|_ _| \ | |/ ___|  _ \  / \  |  \/  |  \/  |
% | |\/| |  _| | |_| | |_) || ||  \| | |  _| | | |/ _ \ | |\/| | |\/| |
% | |  | | |___|  _  |  _ < | || |\  | |_| | |_| / ___ \| |  | | |  | |
% |_|  |_|_____|_| |_|_| \_\___|_| \_|\____|____/_/   \_\_|  |_|_|  |_|
\begin{figure}
    \centering
    \includegraphics[width=0.7\columnwidth]{fig/im_mehringdamm_ecdf_every.pdf}
    \caption{%
        ECDFs of the measured durations for crossing the scenario \textit{Mehringdamm}.
        The results when using our models for all, medium ($m$) and fast ($f$) cyclists are only slightly more realistic than when using the standard SUMO model.
        However, when the \textit{direct} path is blocked for cyclists, the simulation results outperform the default approach.
    }%
    \label{fig:im_mehringdamm}
\end{figure}

Second, in some cases, we were able to improve our results by adjusting the left-turn behavior distribution following the second distribution discussed in \Cref{subsec:left-turn_behavior_at_intersections_preprocessing}.
The ``lane only'' results in \Cref{fig:im_mehringdamm} were achieved by prohibiting cyclists from using the \textit{direct} path.
Obviously, it takes much longer for cyclists to cross the intersection than SUMO's default simulation model suggests.
When examining SimRa trajectories at this particular intersection, almost all cyclists chose the \textit{indirect} path as the infrastructure guides cyclists to do so.
Hence, manually adjusting the left-turn behavior distribution for such intersections is crucial.

%% NOT A GOOD MATCH
%     _    _     _______  __    _    _   _ ____  _____ ____
%    / \  | |   | ____\ \/ /   / \  | \ | |  _ \| ____|  _ \
%   / _ \ | |   |  _|  \  /   / _ \ |  \| | | | |  _| | |_) |
%  / ___ \| |___| |___ /  \  / ___ \| |\  | |_| | |___|  _ <
% /_/   \_\_____|_____/_/\_\/_/   \_\_| \_|____/|_____|_| \_\
\begin{figure}
    \centering
    \includegraphics[width=0.7\columnwidth]{fig/im_alex_ecdf_every.pdf}
    \caption{%
        ECDFs of the measured durations for crossing the scenario \textit{Alexanderstraße}.
        Here, our new approach is not more precise than SUMO default behavior.
    }%
    \label{fig:im_alex}
\end{figure}

Third, at a few intersections, the results of our approach do not yet sufficiently reflect real-world cycling behavior (see \Cref{fig:im_alex}).
We discuss possible reasons for this in \Cref{sec:discussion_sumo}.

Fourth, creating three cyclist models based on their average velocity also revealed, that SUMO's default model behaves like fast cyclists.
This becomes clear when looking at \Cref{fig:im_warschauer,fig:im_mehringdamm,fig:im_alex}, since the lines representing the cyclists modeled with our fast cyclist model are the closest to the red line representing SUMO default.


\section{Discussion}
\label{sec:discussion_sumo}
Overall, the results presented in this chapter show a significant improvement over the state-of-the-art.
Nevertheless, they still have a number of shortcomings.
In this section, we discuss the inherent limitations of our approach in general (\Cref{subsec:methodological_challenges_sumo}) as well as problems resulting from the SimRa dataset as our ground truth data (\Cref{subsec:dataset_choice_as_ground_truth}).
We also describe a potential problem regarding e-bikes in \Cref{subsec:e-bikes}.

%  __  __ _____ _   _ ____  ___ _   _  ____ ____    _    __  __ __  __
% |  \/  | ____| | | |  _ \|_ _| \ | |/ ___|  _ \  / \  |  \/  |  \/  |
% | |\/| |  _| | |_| | |_) || ||  \| | |  _| | | |/ _ \ | |\/| | |\/| |
% | |  | | |___|  _  |  _ < | || |\  | |_| | |_| / ___ \| |  | | |  | |
% |_|  |_|_____|_| |_|_| \_\___|_| \_|\____|____/_/   \_\_|  |_|_|  |_|
\begin{figure}
    \centering
    \includegraphics[width=0.7\columnwidth]{fig/mehringdamm_island_arrows.png}
    \caption{Intersection Mehringdamm/Gneisenaustraße: a traffic island obstructs the direct turn path (dashed line) and, thus, makes the indirect path (solid line) more likely to be used.}
    \label{fig:mehringdamm_traffic_island}
\end{figure}

\subsection{Methodological Challenges}
\label{subsec:methodological_challenges_sumo}
%Generalization Problem
%\paragraph{Generalizing Behavior}
Our initial assumption was that the behavior of cyclists in a single intersection cannot be generalized to all intersections~\cite{kaths2016integration} but that the average behavior across a large number of intersections will be close enough to cyclists' behavior at arbitrary intersections.
This seems to be true only for a (relatively large) subset of intersections -- apparently, the intersection behavior of cyclists is more heterogeneous than expected.
We believe that this is due to the fact that we averaged across all intersections in our dataset whereas there are apparently different classes of intersections that we did not account for.

Primarily, the intersection design is likely to have a strong impact:
Consider the example in \Cref{fig:mehringdamm_traffic_island} where a traffic island partially blocks direct left turns and where markings on the ground suggest indirect turns.
As another example, the intersection Bismarckstraße/Leibnizstraße had no direct left turns in the SimRa dataset.
In this intersection, the reason would be that cyclists legally have to use a bike lane.
When using that bike lane, a direct left turn would require cyclists to first pass through a row of parked cars, then to cross four car lanes of a major street before being able to turn left.

Aside from that, other possible influence factors include the amount and velocity of traffic (higher numbers of cars or faster cars can be expected to lead to more indirect turns), gender and age group distributions of cyclists in the respective intersections, as well as weather and light conditions or the grade of the street.
In future work, we plan to explore these possible influence factors, focusing on the intersection design which we deem to have the strongest impact.

Another problem results from inaccuracy in the dataset used:
\ac{gps} and motion sensors of smartphones provide only imprecise insights into actual ``micro''-behavior of cyclists.
Using a broad group of cyclists as input will always result in this limitation which we tried to overcome based on preprocessing and filtering of the SimRa dataset.
Alternatives would be additional sensors (especially cameras) on bicycles or on intersections as in \cite{kaths2016integration}.
These, however, have the inherent limitation that they will either limit the number of bicycles producing data or the number of intersections covered.

\subsection{Dataset Choice as Ground Truth}
\label{subsec:dataset_choice_as_ground_truth}
In this chapter, we used the SimRa datasets as input for our analysis as it is, to the best of our knowledge, the first public dataset comprising a large number of trips that actually publishes individual trips in an anonymized but non-aggregated form.
We need to keep in mind, however, that SimRa was designed for a different purpose:
For example, the SimRa app records motion sensors at \SI{50}{\hertz} but only persists every fifth value of a moving average over 30 values.
While this suffices for detecting incidents~\cite{karakaya2020simra}, it further limits the resolution of motion data (and thus any conclusions we can draw from that).
Furthermore, the SimRa data which we used were recorded over a period of 1.5 years.
During such as long period of time, physical changes to the bicycle infrastructure (both temporary and permanent) will occur, thus, adding additional noise to the data.

Finally, SimRa relies on crowdsourcing as a data collection method which often leads to participation inequality.
As a result, individual users will be overrepresented in some intersections and street segments and not represented in others.
Furthermore, based on the data collection method using smartphones, the user group of SimRa is likely to have a slight gender bias towards males and an age group bias towards cyclists between the ages \num{20} and \num{50}.
These biases will, of course, be reflected in our analysis results and cannot be compensated unless other cycling datasets become available in non-aggregated form.

\subsection{Generalizability}%
\label{subsec:problem_general}
The SimRa dataset which we used to analyse the longitudinal kinematic behavior contains trips from almost \num{100} regions from Germany, Switzerland and Austria, which increases the generalizability.
However, to derive and evaluate the left-turn model, we need data from intersections with many left-turns, with the same orientation, e.g., entering the intersection from the south and leaving it to the west.
Mind, that we also split the trips into three groups: slow, medium and fast.
Only the regions Berlin, Munich and Nuremberg provide eligible data for this, since almost half the trips are from these regions~\cite{karakaya2023cyclesense}.
This is further aggravated by the fact that the preprocessing step (see \Cref{sec:cycling_behavior_in_simra_and_sumo}) further reduces the number of eligible trips and with that the number of intersections with sufficient left-turn maneuvers.
Nevertheless, this does not pose a threat to the generalizability of our findings -- at least for Germany -- as traffic infrastructure guidelines throughout Germany are standardized.
Furthermore, adjacent countries such as Austria often also have comparable infrastructure.
Additionally, this problem is not present with the evaluation of the longitudinal kinematic behavior, since we only need more or less straight routes without any sharp turns.
We hence believe that our findings also apply to at least these countries.

\subsection{E-bikes}
\label{subsec:e-bikes}
Another potential threat to the realism of our approach are e-bikes, since they support the cyclist, potentially leading to higher acceleration and velocity.
To analyze this, we filtered out the e-bikes and found, that the SimRa dataset only contains about \num{4000} e-bike trips, which is less than \num{5}\%.
We redid the analyses of the three cyclist groups and found out, that the change in the results is barely noticeable.
And there are not enough e-bike trips to create a dedicated e-bike model with a high credibility.


\section{Alternative Approaches}
\label{sec:related_work_sumo}
% this section is about how people have been trying to improve sumo
In this section, we give an overview of related work on improving intersection behavior (\Cref{subsec:rw_intersection}) and longitudinal (\Cref{subsec:rw_longitudinal}) behavior of cyclists in SUMO's simulation models.

% intersection behavior
\subsection{Intersection Behavior of Cyclists}%
\label{subsec:rw_intersection}

% intersection behavior in sumo with external tool
\textcite{kaths2016integration} aim to address the shortcomings of SUMO's intersection model for cyclists.
For this, they record video footage of an example intersection in Munich and derive cyclist trajectories.
From the set of trajectories, they select one representative trajectory for each combination of start and end points in the intersection and make it available to SUMO via an external API.
While this is a significant improvement in realism over SUMO's intersection model, it is hard to generalize to other intersections and cannot cover the plurality of trajectories chosen by real-world cyclists.

% Traffic flow at signalized intersections with large volumes of bicycle traffic

Similar to \textcite{kaths2016integration}, \textcite{grigoropoulos2022traffic} analyze video footage of intersections with the goal of better understanding the intersection behavior of cyclists.
Their focus, however, is not on deriving an improved intersection model but rather on identifying best practices for traffic planners working on intersections with high volumes of cycling traffic.
% bicycle lanes into sumo for better behavior, esp. at intersections
\textcite{grigoropoulos2019modelling} propose to adjust the default traffic infrastructure inside SUMO to achieve more realistic cyclist behavior at intersections.
Here, they focus on the number and shape of bicycle lanes which, however, are highly specific and differ from intersection to intersection.

% Longitudinal behavior
\subsection{Longitudinal Behavior of Cyclists}%
\label{subsec:rw_longitudinal}

\textcite{twaddle2016modeling} examine four models for the longitudinal kinematic behavior of cyclists, i.e., acceleration and velocity.
The first, called Constant Model, is the simplest and is the SUMO default:
Cyclists accelerate and decelerate at a constant rate until the desired velocity is reached.
This model works well when breaking to a full stop but leads to frequent acceleration jumps between a fixed positive or negative value and zero, which is not realistic cyclist behavior.
In the Linear Decreasing Model, maximum acceleration is reached when starting the acceleration maneuver and then linearly declines until the desired velocity is reached.
This model is outperformed by all other models.
In the third and fourth models, Polynomial and Two Term Sinusoidal Model, acceleration or deceleration start at zero and then gradually grow over time.
In their paper, \textcite{twaddle2016modeling} analyze the video recordings of 1,030 trips in four intersections in Munich, Germany and conclude that the Polynomial Model has overall the most realistic cyclist behavior but is, however, not trivial to implement in SUMO.

% different approach - integrating a real bicycle, recording traces
A different approach of achieving realistic cycling behavior in SUMO is taken by \textcite{heinovski2019modeling}.
The authors simulate multiple traffic scenarios in which accidents between cars and cyclists occur to investigate the effects of wireless communication between cyclists and other road users in the context of accident prevention.
In order to obtain realistic cycling behavior for SUMO, they set up a novel Virtual Cycling Environment (VCE) featuring an actual bicycle that is connected to the simulation via multiple sensors.
The VCE supports interactive empirical studies in a physically safe environment and allows the authors to record the cyclists' behavior in the form of trajectories.
They use a set of recorded trajectories from different cyclists for emulating realistic cycling behavior inside SUMO to simulate accidents.
Although their approach produces trajectories from cyclists created with an actual bicycle, it does only achieve limited realism, since no other road users were present when recording the trajectories.
Furthermore, deriving a realistic set of trajectories requires a large number of test persons.


\section{Summary}
\label{sec:summary_sumo}


Increasing the modal share of cyclists to provide health benefits, alleviate traffic congestion, and reduce air pollution requires significant planning efforts of city planners and traffic engineers towards an improved cycling infrastructure.
For this, city planners often rely on the open source simulation platform SUMO to study the effects of infrastructure changes before implementing them on the streets.
Likewise, research on V2X-based safety systems for cyclists often relies on SUMO for evaluation.
Unfortunately, SUMO cyclists are either modeled as slow cars or as fast pedestrians, neither of which is overly realistic.

In this chapter, we used the recently published SimRa dataset, which to our knowledge is the first public dataset providing detailed insights into a large number of individual cyclists' trips, to improve SUMO's cyclist model.
For this, we split the trips into three categories based on their average velocity, after the stops are filtered out: slow, medium, and fast.
We then derived acceleration, deceleration and velocity behaviors for each of these three cyclist groups and reparameterized the SUMO cyclist models.
As a SUMO extension, we also developed a new intersection model describing left-turn behaviors of cyclists of the three new groups in four-way intersections.
While our work significantly improved the existing cyclist model, it is not as realistic as we wanted it to be.
We, hence, discussed a number of research directions which we plan to explore in the near future.
